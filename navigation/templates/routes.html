{% load custom_tags %}
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Routes</title>
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.1.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.1.0/ol.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <header>
        <h1 class="header-text">Map</h1>
    </header>
    <div class="menu-container">
        <button id="menu-button" class="menu-button">&#9776;</button>
        <div class="menu">
            <ul>
                {% comment %} <li><a href="{% url 'index' %}">HomePage</a></li> {% endcomment %}
                {% comment %} <li><a href="{% url 'bookings' %}">Bookings</a></li> {% endcomment %}
                {% comment %} <li><a href="{% url 'login' %}">Login</a></li> {% endcomment %}
                {% comment %} <li><a href="{% url 'map' %}">Map</a></li> {% endcomment %}
                <li><a href="#">About us</a></li>
            </ul>
            <div class="menu-image">
                <img src="{% static 'images/donkey.png' %}" alt="Image Description">
            </div>
        </div>
    </div>
    <div class="contents flex-around">
        <div id="map" class="route-map"></div>
        <div class="controls">
            <ul class="map-list">
                <li><a href="">New Route</a></li>
                <li><a href="">List Routes</a></li>
                <li><a href="">Save Route</a></li>
                <li><a href="">Reset Route</a></li>
                <li><a href="">Send Route</a></li>
            </ul>
        </div>
    </div>
    <footer>
        <div class="footer-content">
            <p>&copy; 2023 DonkeyTravel. All rights reserved.</p>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Create a map object
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([5.048809728652404, 51.6514359606463]),
                zoom: 17
            })
        });

        // Create a source for drawing features
        const drawSource = new ol.source.Vector();

        // Create a vector layer for the drawn features
        const drawLayer = new ol.layer.Vector({
            source: drawSource
        });

        map.addLayer(drawLayer);

        // Create a drawing interaction
        const draw = new ol.interaction.Draw({
            source: drawSource,
            type: 'LineString'
        });

        map.addInteraction(draw);

        // Function to submit LineString data to Django
        function submitLineStringData(coordinates) {
            const lineString = {
                type: 'LineString',
                coordinates: coordinates
            };

            // Send the LineString data to Django as a POST request with CSRF token
            $.ajax({
                url: '/follow-me/routes/',
                method: 'POST',
                data: JSON.stringify({
                    action: 'create',  // Specify the action here
                    type: 'LineString',
                    coordinates: lineString,
                    description: 'Example',
                    duration: 5
                }),
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function(data) {
                    console.log('LineString data sent to Django successfully.');
                },
                error: function(error) {
                    console.error('Error sending LineString data to Django.');
                }
            });
        }

        // Function to retrieve the CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Event handler for when a feature is drawn
        draw.on('drawend', function (event) {
            const feature = event.feature;
            const coordinates = feature.getGeometry().getCoordinates();

            // Call the function to submit LineString data to Django
            submitLineStringData(coordinates);
        });
    </script>
</body>
</html>
